<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gaussian Splatting - Scene Selector</title>
    <style>
        body { margin: 0; overflow: hidden; }
        canvas { display: block; }
        .scene-controls {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .scene-controls button {
            padding: 8px 12px;
            font-size: 16px;
            cursor: pointer;
            border: 1px solid #ccc;
            background-color: #fff;
            border-radius: 5px;
        }
        .scene-controls button:hover {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>

    <!-- Scene을 선택할 버튼들을 담을 컨테이너 -->
    <div class="scene-controls">
        <button data-scene-key="scene1">Scene 1</button>
        <button data-scene-key="scene2">Scene 2</button>
        <button data-scene-key="scene5">Scene 3</button>
        <button data-scene-key="scene6">Scene 4</button>
    </div>

    <canvas id="splat-canvas"></canvas>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.157.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.157.0/examples/jsm/",
            "@lumaai/luma-web": "https://unpkg.com/@lumaai/luma-web@0.2.0/dist/library/luma-web.module.js"
        }
    }
    </script>

    <script type="module">
    import { WebGLRenderer, PerspectiveCamera, Scene } from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { LumaSplatsThree } from '@lumaai/luma-web';

    // --- 기본 설정 ---
    const canvas = document.getElementById('splat-canvas');
    const renderer = new WebGLRenderer({
        canvas: canvas,
        antialias: false
    });
    renderer.setSize(window.innerWidth, window.innerHeight, false);

    const scene = new Scene();
    const camera = new PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.z = 2;

    const controls = new OrbitControls(camera, canvas);
    controls.enableDamping = true;

    // --- 장면 소스 관리 ---
    // 각 장면에 해당하는 Luma AI URL 목록
    const sceneSources = {
        scene1: 'https://lumalabs.ai/capture/d80d4876-cf71-4b8a-8b5b-49ffac44cd4a',
        scene2: 'https://lumalabs.ai/capture/016ff4ce-847a-47b6-a3ba-9017339797f5',
        scene3: 'https://lumalabs.ai/capture/ca9ea966-ca24-4ec1-ab0f-af665cb546ff',
        scene4: 'https://lumalabs.ai/capture/1b5f3e33-3900-4398-8795-b585ae13fd2d',
        scene5: 'https://lumalabs.ai/capture/4da7cf32-865a-4515-8cb9-9dfc574c90c2',
        scene6: 'https://lumalabs.ai/capture/da82625c-9c8d-4d05-a9f7-3367ecab438c'
    };
    
    // 현재 장면에 표시되고 있는 splat 객체를 추적하기 위한 변수
    let currentSplat = null;

    // --- 장면 로딩 함수 ---
    function loadScene(sourceUrl) {
        // 이전에 로드된 splat 객체가 있다면 scene에서 제거
        if (currentSplat) {
            scene.remove(currentSplat);
            // 필요하다면 메모리 해제 로직 추가 (라이브러리가 지원하는 경우)
            // currentSplat.dispose(); 
        }

        // 새로운 LumaSplatsThree 객체 생성
        const splat = new LumaSplatsThree({
            source: sourceUrl,
            // 로딩 중 에러가 발생했을 때 처리
            onError: (err) => {
                console.error("장면 로딩 에러:", err);
                // 여기에 사용자에게 에러를 알리는 UI 로직을 추가할 수 있습니다.
            }
        });

        // splat 로드가 완료되면 실행될 콜백 함수
        splat.onLoad = () => {
            // 주변 환경 맵(environment map)과 배경을 캡처하여 설정
            splat.captureCubemap(renderer).then((capturedTexture) => {
                scene.environment = capturedTexture;
                scene.background = capturedTexture;
                scene.backgroundBlurriness = 0.5;
            });
        };
        
        // 새로운 splat을 scene에 추가
        scene.add(splat);
        
        // 현재 splat 객체를 새로 만든 객체로 업데이트
        currentSplat = splat;
    }

    // --- 이벤트 리스너 설정 ---
    // 모든 버튼에 클릭 이벤트 리스너 추가
    document.querySelectorAll('.scene-controls button').forEach(button => {
        button.addEventListener('click', (event) => {
            const sceneKey = event.target.dataset.sceneKey;
            const sourceUrl = sceneSources[sceneKey];
            if (sourceUrl) {
                console.log(`${sceneKey} 로드 중...`);
                loadScene(sourceUrl);
            }
        });
    });

    // --- 애니메이션 루프 및 초기화 ---
    renderer.setAnimationLoop(() => {
        controls.update();
        renderer.render(scene, camera);
    });

    // 창 크기가 변경될 때 렌더러와 카메라 비율 업데이트
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // 페이지가 처음 로드될 때 기본 장면(Scene 1)을 로드
    loadScene(sceneSources.scene1);

    </script>
</body>
</html>